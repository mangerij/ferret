<!DOCTYPE html><head><meta charset="UTF-8"><title>Just in Time Compilation | Ferret</title><link href="../../../contrib/materialize/materialize.min.css" type="text/css" rel="stylesheet" media="screen,projection"></link><link href="../../../contrib/prism/prism.min.css" type="text/css" rel="stylesheet"></link><link href="../../../css/moose.css" type="text/css" rel="stylesheet"></link><link href="../../../css/devel_moose.css" type="text/css" rel="stylesheet"></link><link href="../../../css/alert_moose.css" type="text/css" rel="stylesheet"></link><link href="../../../css/content_moose.css" type="text/css" rel="stylesheet"></link><link href="../../../css/sqa_moose.css" type="text/css" rel="stylesheet"></link><link href="../../../css/civet_moose.css" type="text/css" rel="stylesheet"></link><script type="text/javascript" src="../../../contrib/jquery/jquery.min.js"></script></head><body><div class="page-wrap"><header><nav><div class="nav-wrapper container"><a href="../../../index.html" class="left moose-logo hide-on-med-and-down" id="home-button">Ferret</a><a href="https://github.com/mangerij/ferret" class="right"><img src="../../../media/framework/github-logo.png" class="github-mark"></img><img src="../../../media/framework/github-mark.png" class="github-logo"></img></a><ul class="right hide-on-med-and-down"><li><a href="#!" class="dropdown-trigger" data-target="150974cd-b108-402a-9756-32ebea15c2ba" data-constrainWidth="false">Get Started<i class="material-icons right">arrow_drop_down</i></a></li><li><a href="#!" class="dropdown-trigger" data-target="a9f0fd66-6edf-4e22-8285-8146743b4ae8" data-constrainWidth="false">Theory<i class="material-icons right">arrow_drop_down</i></a></li><li><a href="#!" class="dropdown-trigger" data-target="6d24240a-8549-416d-a2b0-2809532bd0d0" data-constrainWidth="false">Tutorials<i class="material-icons right">arrow_drop_down</i></a></li><li><a href="#!" class="dropdown-trigger" data-target="ff9446d9-87b9-4a43-805f-e7e936e04ebb" data-constrainWidth="false">EU Horizon2020-IF<i class="material-icons right">arrow_drop_down</i></a></li><li><a href="../../../publication_highlights/publication_highlights.html">Highlights</a></li><li><a href="#!" class="dropdown-trigger" data-target="798dcd50-79b5-4e3b-a034-f06cb9a7020c" data-constrainWidth="false">Documentation<i class="material-icons right">arrow_drop_down</i></a></li><li><a href="../../../contribute/index.html">Contact</a></li></ul><a href="#" class="sidenav-trigger" data-target="4ac0fc00-64cd-4725-ba78-2853dad1bebf"><i class="material-icons">menu</i></a><ul class="sidenav" id="4ac0fc00-64cd-4725-ba78-2853dad1bebf"><li><a href="#!" class="dropdown-trigger" data-target="11df9425-6094-4d14-b992-dbd6db0cc913" data-constrainWidth="false">Get Started<i class="material-icons right">arrow_drop_down</i></a></li><li><a href="#!" class="dropdown-trigger" data-target="bf6e4804-19af-4fe6-acec-c92b30d07f5e" data-constrainWidth="false">Theory<i class="material-icons right">arrow_drop_down</i></a></li><li><a href="#!" class="dropdown-trigger" data-target="732e236e-6063-483a-9628-86f11e4d21cd" data-constrainWidth="false">Tutorials<i class="material-icons right">arrow_drop_down</i></a></li><li><a href="#!" class="dropdown-trigger" data-target="b55a4c77-990d-4111-b627-8e093430787d" data-constrainWidth="false">EU Horizon2020-IF<i class="material-icons right">arrow_drop_down</i></a></li><li><a href="../../../publication_highlights/publication_highlights.html">Highlights</a></li><li><a href="#!" class="dropdown-trigger" data-target="12166a00-373a-4700-9090-d96890c498a2" data-constrainWidth="false">Documentation<i class="material-icons right">arrow_drop_down</i></a></li><li><a href="../../../contribute/index.html">Contact</a></li></ul><a href="#moose-search" class="modal-trigger"><i class="material-icons">search</i></a></div><ul class="dropdown-content" id="150974cd-b108-402a-9756-32ebea15c2ba"><li><a href="../../../getting_started/install.html">Install FERRET</a></li><li><a href="../../../getting_started/update.html">Update FERRET</a></li><li><a href="../../../getting_started/running.html">Running FERRET</a></li><li><a href="../../../getting_started/paraview.html">Visualization Tools</a></li><li><a href="../../../getting_started/docs.html">Browse the documentation locally</a></li></ul><ul class="dropdown-content" id="a9f0fd66-6edf-4e22-8285-8146743b4ae8"><li><a href="../../../theory/intro_LGD.html">Phase Field Method of Ferroelectricity (FE)</a></li><li><a href="../../../theory/intro_LLG.html">Micromagnetic Simulations</a></li><li><a href="../../../theory/intro_piezo.html">Piezoelectricity</a></li><li><a href="../../../theory/intro_thermo.html">Thermoelectric Phenomena</a></li><li><a href="../../../theory/intro_optical.html">Optical Properties</a></li></ul><ul class="dropdown-content" id="6d24240a-8549-416d-a2b0-2809532bd0d0"><li><a href="../../../tutorials/FE_phase_field_multi_domain.html">Multidomain ferroelectric</a></li><li><a href="../../../tutorials/ferroelectric_domain_wall.html">Ferroelectric domain wall</a></li><li><a href="../../../tutorials/FE_phase_field_multi_domain_coupled.html">Ferroelectric thin film</a></li><li><a href="../../../tutorials/magnetic_ringdown.html">Magnetic ringdown</a></li><li><a href="../../../tutorials/AFM_dynamics.html">Antiferromagnetic dynamics</a></li><li><a href="../../../tutorials/piezoelectric.html">Piezoelectric actuation</a></li><li><a href="../../../tutorials/thermoelectric.html">Polycrystalline thermoelectric transport</a></li></ul><ul class="dropdown-content" id="ff9446d9-87b9-4a43-805f-e7e936e04ebb"><li><a href="../../../MSCA_EU_Horizon2020_Results/horizon2020_results1.html">Background and model</a></li><li><a href="../../../MSCA_EU_Horizon2020_Results/horizon2020_results2.html">Summary of key results</a></li><li><a href="../../../MSCA_EU_Horizon2020_Results/horizon2020_ex1.html">Example (ground states)</a></li><li><a href="../../../MSCA_EU_Horizon2020_Results/horizon2020_ex2.html">Example (FE DWs)</a></li><li><a href="../../../MSCA_EU_Horizon2020_Results/horizon2020_ex3.html">Example (magnetic DWs)</a></li><li><a href="../../../MSCA_EU_Horizon2020_Results/horizon2020_ex4.html">Example (ME switching)</a></li><li><a href="../../../MSCA_EU_Horizon2020_Results/horizon2020_ex5.html">Example (spin wave transport)</a></li></ul><ul class="dropdown-content" id="798dcd50-79b5-4e3b-a034-f06cb9a7020c"><li><a href="../../../syntax/index.html">Complete syntax</a></li><li><a href="../../../syntax/ferret_only_syntax.html">FERRET syntax</a></li></ul><ul class="dropdown-content" id="11df9425-6094-4d14-b992-dbd6db0cc913"><li><a href="../../../getting_started/install.html">Install FERRET</a></li><li><a href="../../../getting_started/update.html">Update FERRET</a></li><li><a href="../../../getting_started/running.html">Running FERRET</a></li><li><a href="../../../getting_started/paraview.html">Visualization Tools</a></li><li><a href="../../../getting_started/docs.html">Browse the documentation locally</a></li></ul><ul class="dropdown-content" id="bf6e4804-19af-4fe6-acec-c92b30d07f5e"><li><a href="../../../theory/intro_LGD.html">Phase Field Method of Ferroelectricity (FE)</a></li><li><a href="../../../theory/intro_LLG.html">Micromagnetic Simulations</a></li><li><a href="../../../theory/intro_piezo.html">Piezoelectricity</a></li><li><a href="../../../theory/intro_thermo.html">Thermoelectric Phenomena</a></li><li><a href="../../../theory/intro_optical.html">Optical Properties</a></li></ul><ul class="dropdown-content" id="732e236e-6063-483a-9628-86f11e4d21cd"><li><a href="../../../tutorials/FE_phase_field_multi_domain.html">Multidomain ferroelectric</a></li><li><a href="../../../tutorials/ferroelectric_domain_wall.html">Ferroelectric domain wall</a></li><li><a href="../../../tutorials/FE_phase_field_multi_domain_coupled.html">Ferroelectric thin film</a></li><li><a href="../../../tutorials/magnetic_ringdown.html">Magnetic ringdown</a></li><li><a href="../../../tutorials/AFM_dynamics.html">Antiferromagnetic dynamics</a></li><li><a href="../../../tutorials/piezoelectric.html">Piezoelectric actuation</a></li><li><a href="../../../tutorials/thermoelectric.html">Polycrystalline thermoelectric transport</a></li></ul><ul class="dropdown-content" id="b55a4c77-990d-4111-b627-8e093430787d"><li><a href="../../../MSCA_EU_Horizon2020_Results/horizon2020_results1.html">Background and model</a></li><li><a href="../../../MSCA_EU_Horizon2020_Results/horizon2020_results2.html">Summary of key results</a></li><li><a href="../../../MSCA_EU_Horizon2020_Results/horizon2020_ex1.html">Example (ground states)</a></li><li><a href="../../../MSCA_EU_Horizon2020_Results/horizon2020_ex2.html">Example (FE DWs)</a></li><li><a href="../../../MSCA_EU_Horizon2020_Results/horizon2020_ex3.html">Example (magnetic DWs)</a></li><li><a href="../../../MSCA_EU_Horizon2020_Results/horizon2020_ex4.html">Example (ME switching)</a></li><li><a href="../../../MSCA_EU_Horizon2020_Results/horizon2020_ex5.html">Example (spin wave transport)</a></li></ul><ul class="dropdown-content" id="12166a00-373a-4700-9090-d96890c498a2"><li><a href="../../../syntax/index.html">Complete syntax</a></li><li><a href="../../../syntax/ferret_only_syntax.html">FERRET syntax</a></li></ul></nav><div class="modal modal-fixed-footer moose-search-modal" id="moose-search"><div class="modal-content container moose-search-modal-content"><div class="gcse-search"></div></div><div class="modal-footer"><a href="#!" class="modal-close btn-flat">Close</a></div></div></header><main class="main"><div class="container"><div class="row"><div class="moose-content col s12 m12 l12"><section id="ee3a23e2-7804-4599-98be-2e1a34f27588" data-section-level="1" data-section-text="Just in Time Compilation"><h1 id="just-in-time-compilation">Just in Time Compilation</h1><div class="card moose-float" style="width:50%;margin-left:20px;float:right;"><div class="card-content"><picture class="materialboxed moose-image"><img src="../../../media/phase_field/jitgraph_white.png"></img></picture><p class="moose-caption"><span class="moose-caption-text">Performance test results for the JIT compile FParser module</span></p></div></div><p>The version of the <em>Function Parser</em> library that ships with MOOSE contains a just in time (JIT) compilation feature that is not present in the <a href="http://warp.povusers.org/FunctionParser/">upstream version</a>.</p><p>Include the JIT module (which also adds <a href="AutomaticDifferentiation.html">automatic differentiation</a> support) with</p><pre class="moose-pre"><code class="language-cpp">
#include &quot;libmesh/fparser_ad.hh&quot;
</code></pre><p>The module provides the class</p><pre class="moose-pre"><code class="language-cpp">
FunctionParserADBase&lt;Real&gt;
</code></pre><p>which derives from</p><pre class="moose-pre"><code class="language-cpp">
FunctionParserBase&lt;Real&gt;
</code></pre><p>and provides the additional method</p><pre class="moose-pre"><code class="language-cpp">
bool JITCompile();
</code></pre><p>Calling this method on an FParser object will execute an attempt at</p><ul class="browser-default"><li><p>generating a small temporary C++ file with a function that performs the calculation of the parsed function </p></li><li><p>launching a compiler (the same compiler used to build libMesh) to compile the C++ file into a small dynamic library (<code>.so</code> file) </p></li><li><p>using <code>dlopen()</code> to immediately load the library file </p></li><li><p>using <code>dlsym()</code> to bind the compiled function to the FParser object</p></li></ul><p>If all steps above succeed all further evaluations (calls to <code>Eval()</code>) of the FParser object will be redirected to the compiled function, which will yield a speedup of about an order of magnitude, depending on the complexity of the function.</p><p>All temporary files will be cleaned up and if JIT compilation succeeded the compiled library will be cached in a directory named <code>.jitcache</code> in the local directory. The name of the function file is constructed using a sha1 hash of the function byte code.</p><p>Compile times are around 100ms per function object. Once cached the <code>JITCompile()</code> call will return after about 1ms. Changing numeric constants in the function will usually not trigger a recompilation. The compiled function respects the current FParser <code>Epsilon</code> setting.</p><p>Almost all FParser opcodes are supported, _except_ <code>PCall</code> and <code>FCall</code>, which are function calls to other FParser objects and calls to custom functions.</p><section id="c961cef3-958c-4b3b-8fb8-a4067582de0e" data-section-level="2" data-section-text="Required header files"><h2 id="required-header-files">Required header files</h2><p>JIT compilation for non-AD parsed functions only requires the <code>cmath</code> standard library header file. Compilation of AD functions with dual numbers  required the <code>ADReal.h</code> header and all headers recursively included by it. For binary-only application distribution these headers may not be readily available.</p><p>The make command <code>make ADRealMonolithic.h</code> can be used to build a redistributable header file sufficient for parsed function JIT compilation. This file can be distributed along with the application binary. The application will use this header to compile AD parsed material functions when the <code>MOOSE_ADFPARSER_JIT_INCLUDE</code> environment variable is set. E.g.:</p><pre class="moose-pre"><code class="language-text">
export MOOSE_ADFPARSER_JIT_INCLUDE=/usr/local/include/ADRealMonolithic.h
</code></pre></section></section></div></div></div></main></div></body><script type="text/javascript" src="../../../contrib/materialize/materialize.min.js"></script><script type="text/javascript" src="../../../contrib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="../../../contrib/prism/prism.min.js"></script><script type="text/javascript" src="../../../js/init.js"></script><script type="text/javascript" src="../../../js/navigation.js"></script><script type="text/javascript" src="https://cse.google.com/cse.js?cx=008852834041008754713:g3ilnhhbbj9"></script><script type="text/javascript" src="../../../js/sqa_moose.js"></script>